<html>

<head>
  <title>Video streaming with Node.js</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  <script src="/dist/shaka-player.compiled.js"></script>
  <script src="/dist/shaka-player.ui.js"></script>
  <link rel="stylesheet" type="text/css" href="/dist/controls.css" />
  <script src="/dist/shaka-player.compiled.debug.js"></script>


</head>

<body>
  <a href="/">Home</a>
  <a href="/profile">
    <p><%=currentUser.name%></p>
  </a>
  <p><a href="#">Email</a>: <%=currentUser.email%></p>
  <a href="/logout">Logout</a>
  <h2><%=video.title%></h2>

  <div class="container">
    <div data-shaka-player-container style="max-width: 40em;">
      <video autoplay data-shaka-player id="video" style="width: 100%; height: 100%;"></video>
    </div>
  </div>

  <input type="text" id="filePath" style="display:none" value=<%= video.filePath %> />
  <br>

  <div class="container bookmark-section">
    <form id="add-bookmark-form" action="/video/<%=video._id%>/" method="POST" style="display: none;">
      <input class="form-control" id="time" type="text" name="time" style="display: none;">
      <div class="form-group ">
        <input class="form-control" id="text" type="text" name="text" placeholder="Bookmark" required>
        <button class="btn btn-warning pull-right" id="create">Add</button>
      </div>

    </form>

    <button type="button" id="bookmark" class="btn btn-warning"><i class="fa fa-bookmark-o"
        aria-hidden="true"></i></button>


    <br><br>


    <h4>Bookmarks:</h4>
    <ul class="list-group" id="bookmark-list">
      <%bookmarks.forEach(function(bookmark){%>
      <%if(bookmark.video._id.equals(video._id)){%>
      <li class="list-group-item" style="padding-bottom: 15px;">
        <span class="gotoBookmark" style="cursor: pointer;"><strong><%=bookmark.timestamp%></strong></span> :
        <%=bookmark.text%>
        <div class="pull-right">
          <form style="display: inline" method="POST"
            action="/courses/<%=course._id%>/video/<%=video._id%>/bookmark/<%=bookmark._id%>" class="delete-item-form">
            <button type="submit" class="btn btn-sm btn-danger"><i class="fa fa-trash" aria-hidden="true"></i></button>
          </form>
        </div>
      </li>
      <%}%>
					
				<%})%>
    </ul>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>

  <script src="/js/shaka-config.js"></script>

  <script>
    $("#bookmark").click(function () {
      $("#add-bookmark-form").toggle();
      console.log(video.currentTime);
      timeStamp = Math.floor(video.currentTime);
      console.log(timeStamp);
      var min = Math.floor(timeStamp / 60);
      var sec = timeStamp % 60;
      if (sec < 10) {
        timeStamp = min + ":0" + sec;
      } else {
        timeStamp = min + ":" + sec;
      }
      document.getElementById("time").value = timeStamp;
    });

    $(".delete-item-form").submit(function (e) {
      e.preventDefault();
      var confirmResponse = confirm("Are you sure?");
      if (confirmResponse) {
        var actionUrl = $(this).attr("action");
        var $itemToDelete = $(this).closest(".list-group-item");
        $.ajax({
          url: actionUrl,
          type: "DELETE",
          itemToDelete: $itemToDelete,
          success: function (data) {
            this.itemToDelete.remove();
          },
        });
      } else {
        $(this).find("button").blur();
      }
    });

    $("#add-bookmark-form").submit(function (e) {
      e.preventDefault();
      $("#add-bookmark-form").toggle();
      var bookmarkItem = $(this).serialize();
      console.log(bookmarkItem);

      $.post(
        "/courses/<%=course._id%>/video/<%=video._id%>",
        bookmarkItem,
        function (data) {
          $("#bookmark-list").append(
            `<li class="list-group-item">
                    <span class="gotoBookmark" style="cursor: pointer;"><strong>${data.bookmark.timestamp}</strong><span>  : ${data.bookmark.text}
                    <div class="pull-right">
                    <form style="display: inline" method="POST" action="/courses/${data.course._id}/video/${data.video._id}/bookmark/${data.bookmark._id}" class="delete-item-form">
                        <button type="submit" class="btn btn-sm btn-danger"><i class="fa fa-trash" aria-hidden="true"></i></button>
                    </form>
                    </div>
                </li>`
          );

          $(".delete-item-form").submit(function (e) {
            e.preventDefault();
            var confirmResponse = confirm("Are you sure?");
            if (confirmResponse) {
              var actionUrl = $(this).attr("action");
              var $itemToDelete = $(this).closest(".list-group-item");
              $.ajax({
                url: actionUrl,
                type: "DELETE",
                itemToDelete: $itemToDelete,
                success: function (data) {
                  this.itemToDelete.remove();
                },
              });
            } else {
              $(this).find("button").blur();
            }
          });
        }
      );

      $(this).find("#text").val("");
    });

    $(".gotoBookmark").click(function () {
      time = $(this).text();
      [min, sec] = time.split(":");
      time = 60 * min + Number(sec);
      video.currentTime = time;
    });
  </script>




</body>

</html>