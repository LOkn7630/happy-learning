<html>
<head> 
	<title>Video streaming with Node.js</title>
	<link rel="stylesheet" href="https://cdn.plyr.io/3.6.2/plyr.css" />
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<style>
		.container {
			width:640px;
			height:360px;
			margin: 0 auto;
		  }
		  .plyr {
			border-radius: 4px;
			margin-bottom: 15px;
			--plyr-color-main: #f5e342;
		  }
	</style>
</head> 
<body>
		<a href="/">Home</a>
		<a href="/profile"><p><%=currentUser.name%></p></a>
		<p><a href="#">Email</a>: <%=currentUser.email%></p>
		<a href="/logout">Logout</a>
		<h2><%=video.title%></h2>

		<!-- <video id="video" width="640" controls>
			<source src="/courses/<%=course._id%>/video/watch/<%=video._id%>" type="video/mp4">
		</video> -->

		<div class="container">
			<video controls crossorigin playsinline id="player">
				<!-- Video files -->
				<source src="/courses/<%=course._id%>/video/watch/<%=video._id%>" type="video/mp4" size="1080">
				<!-- Fallback for browsers that don't support the <video> element -->
							
			</video>
			</div>
		
		<div>
			<form id="add-bookmark-form" action="/video/<%=video._id%>/" method="POST" style="display: none;">
				<input id="time" type="text" name="time" style="display: none;">
				<input id="text" type="text" name="text" placeholder="text">
				<button id="create">Create</button>
			</form>
	
				<button id="bookmark">Bookmark</button>
		</div>
	
		<div>Bookmarks</div>

		<ul class="list-group" id="bookmark-list">
			<%bookmarks.forEach(function(bookmark){%>
				<%if(bookmark.video._id.equals(video._id)){%>
					<li class="list-group-item">
						<span class="gotoBookmark" style="cursor: pointer;"><%=bookmark.timestamp%></span> : <%=bookmark.text%>
						<div class="pull-right">
							<form style="display: inline" method="POST" action="/courses/<%=course._id%>/video/<%=video._id%>/bookmark/<%=bookmark._id%>" class="delete-item-form">
								<button type="submit" class="btn btn-sm btn-danger">Delete</button>
							</form>
						</div>
					</li>
					
				<%}%>
				
			<%})%>
		</ul>

	 
	
	  <script src="https://cdn.plyr.io/3.6.2/plyr.js"></script>
	  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
	  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	
	<script type="text/javascript">
		var video         =document.getElementById('video'),
			create        =document.getElementById("create"),
			bookmark      =document.getElementById("bookmark"),
			time          =document.getElementById("time");
			//gotoBookmark  =document.getElementsByClassName("gotoBookmark");
		let timeStamp;

		document.addEventListener('DOMContentLoaded', () => { 
			const player = new Plyr('#player');
			window.player = player;
			function on(selector, type, callback) {
			  document.querySelector(selector).addEventListener(type, callback, false);
			}
		  });


		$('#bookmark').click(function(){
			$('#add-bookmark-form').toggle();
			console.log(video.currentTime)
			//console.log(video.currentTime+20)
			timeStamp=Math.floor(video.currentTime);
			console.log(timeStamp)
			var min = Math.floor(timeStamp / 60 );
			var sec=timeStamp%60;
			if(sec<10){
				timeStamp=min+":0"+sec;
			}else{
				timeStamp=min+":"+sec;
			}
			// console.log(timeStamp)
			document.getElementById('time').value=timeStamp;
			//console.log(timeStamp)
		})

		$('.delete-item-form').submit(function(e){
			e.preventDefault();
			var confirmResponse = confirm('Are you sure?');
			if(confirmResponse) {
				var actionUrl = $(this).attr('action');
				var $itemToDelete = $(this).closest('.list-group-item');
				$.ajax({
					url: actionUrl,
					type: 'DELETE',
					itemToDelete: $itemToDelete,
					success: function(data) {
						this.itemToDelete.remove();
					}
				})
			} else {
				$(this).find('button').blur();
			}
		})

		
		$('#add-bookmark-form').submit(function(e){
			e.preventDefault();
			$('#add-bookmark-form').toggle();
			var bookmarkItem=$(this).serialize();
			console.log(bookmarkItem);
		
			$.post('/courses/<%=course._id%>/video/<%=video._id%>', bookmarkItem, function(data){

				
				$('#bookmark-list').append(
					`<li class="list-group-item">
						<span class="gotoBookmark" style="cursor: pointer;">${data.bookmark.timestamp}<span>  : ${data.bookmark.text}
						<div class="pull-right">
						<form style="display: inline" method="POST" action="/courses/${data.course._id}/video/${data.video._id}/bookmark/${data.bookmark._id}" class="delete-item-form">
							<button type="submit" class="btn btn-sm btn-danger">Delete</button>
						</form>
						</div>
					</li>`
				)
			})
			
			$(this).find('#text').val('');
		})
	
		$(".gotoBookmark").click(function(){
			time=$(this).text();
			[min, sec]=time.split(":");
			time=(60*min)+Number(sec);
			video.currentTime=time;
		})
		
	</script>
	
	


</body> 
</html>
